# Rusty Audio - PWA Deployment Guide

Complete guide for deploying Rusty Audio as a Progressive Web App (PWA) using WebAssembly.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Building for WASM](#building-for-wasm)
3. [Local Testing](#local-testing)
4. [Deployment Targets](#deployment-targets)
5. [Performance Optimization](#performance-optimization)
6. [PWA Features](#pwa-features)
7. [Troubleshooting](#troubleshooting)
8. [Bundle Size Analysis](#bundle-size-analysis)

---

## Prerequisites

### Required Tools

1. **Rust Toolchain** (latest stable)
   ```bash
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   rustup target add wasm32-unknown-unknown
   ```

2. **wasm-bindgen-cli**
   ```bash
   cargo install wasm-bindgen-cli
   ```

3. **WASM Optimization Tools**
   ```bash
   # Linux
   sudo apt-get install binaryen

   # macOS
   brew install binaryen

   # Or build from source
   cargo install wasm-opt
   ```

4. **Optional: Compression Tools**
   ```bash
   # For optimal CDN deployment
   npm install -g brotli gzip
   ```

### Verification

Check all tools are installed:
```bash
rustc --version
wasm-bindgen --version
wasm-opt --version
```

---

## Building for WASM

### Quick Build

Run the build script:
```bash
./scripts/build-wasm.sh
```

This will:
1. ✅ Compile Rust to WebAssembly
2. ✅ Generate JavaScript bindings with wasm-bindgen
3. ✅ Optimize WASM with wasm-opt (50-70% size reduction)
4. ✅ Copy static assets (HTML, manifest, service worker)
5. ✅ Create compressed versions (gzip, brotli)
6. ✅ Generate build manifest

### Advanced Build Options

**Clean build:**
```bash
CLEAN=true ./scripts/build-wasm.sh
```

**Debug build (faster compilation, larger size):**
```bash
PROFILE=dev ./scripts/build-wasm.sh
```

**Maximum optimization (slower build, smallest size):**
```bash
OPTIMIZE_LEVEL=z ./scripts/build-wasm.sh
```

**Custom optimization profile:**
```bash
PROFILE=release OPTIMIZE_LEVEL=3 ./scripts/build-wasm.sh
```

### Build Output

After successful build, `dist/` contains:
```
dist/
├── index.html              # Main HTML entry point
├── manifest.json           # PWA manifest
├── sw.js                   # Service worker
├── rusty_audio.js          # JavaScript bindings
├── rusty_audio_bg.wasm     # Optimized WASM binary
├── rusty_audio_bg.wasm.gz  # Gzip compressed WASM
├── rusty_audio_bg.wasm.br  # Brotli compressed WASM
├── rusty_audio.js.gz       # Gzip compressed JS
├── rusty_audio.js.br       # Brotli compressed JS
├── build-manifest.json     # Build metadata
└── icon-*.png              # PWA icons (various sizes)
```

---

## Local Testing

### Method 1: Python HTTP Server (Recommended)

```bash
./scripts/deploy-wasm.sh local
```

Or manually:
```bash
cd dist
python3 -m http.server 8080
```

Open: http://localhost:8080

### Method 2: npm http-server

```bash
cd dist
npx http-server -p 8080 -c-1
```

### Method 3: Rust Simple Server

```bash
cargo install simple-http-server
cd dist
simple-http-server -p 8080
```

### Testing PWA Features

1. **Open DevTools** (F12)
2. **Application Tab** → Check:
   - ✅ Manifest loaded correctly
   - ✅ Service Worker registered
   - ✅ Cache Storage populated
   - ✅ Icons visible in manifest

3. **Install PWA**:
   - Click install prompt (bottom of page)
   - Or: Chrome menu → "Install Rusty Audio..."

4. **Test Offline**:
   - DevTools → Network → Enable "Offline"
   - Refresh page → should still load from cache

---

## Deployment Targets

### GitHub Pages

**Automatic deployment:**
```bash
./scripts/deploy-wasm.sh github
```

**Manual steps:**
1. Build: `./scripts/build-wasm.sh`
2. Create `gh-pages` branch
3. Copy `dist/` contents to root
4. Push to GitHub
5. Enable in Settings → Pages → Source: gh-pages

**URL:** `https://username.github.io/rusty-audio/`

### Cloudflare Pages

**Automatic deployment:**
```bash
./scripts/deploy-wasm.sh cloudflare
```

**Prerequisites:**
```bash
npm install -g wrangler
wrangler login
```

**Manual deployment:**
1. Build: `./scripts/build-wasm.sh`
2. `wrangler pages deploy dist --project-name rusty-audio`

**Features:**
- ✅ Global CDN
- ✅ Automatic HTTPS
- ✅ Free tier: Unlimited bandwidth
- ✅ Edge caching

### Netlify

**Automatic deployment:**
```bash
./scripts/deploy-wasm.sh netlify
```

**Prerequisites:**
```bash
npm install -g netlify-cli
netlify login
```

**Manual deployment:**
1. Create `netlify.toml` (auto-generated by script)
2. `netlify deploy --prod --dir dist`

### Vercel

**Automatic deployment:**
```bash
./scripts/deploy-wasm.sh vercel
```

**Prerequisites:**
```bash
npm install -g vercel
vercel login
```

### Docker Container

**Build Docker image:**
```bash
./scripts/deploy-wasm.sh docker
```

**Run locally:**
```bash
docker run -p 8080:80 rusty-audio-pwa:latest
```

**Deploy to cloud:**
```bash
# AWS ECS
docker tag rusty-audio-pwa:latest your-ecr-repo/rusty-audio:latest
docker push your-ecr-repo/rusty-audio:latest

# Google Cloud Run
docker tag rusty-audio-pwa:latest gcr.io/your-project/rusty-audio:latest
docker push gcr.io/your-project/rusty-audio:latest
gcloud run deploy rusty-audio --image gcr.io/your-project/rusty-audio:latest
```

---

## Performance Optimization

### WASM Bundle Size Optimization

Current optimizations achieve **50-70% size reduction**:

1. **Rust Compiler Optimizations** (Cargo.toml):
   ```toml
   [profile.release]
   opt-level = 'z'        # Optimize for size
   lto = "fat"            # Link-time optimization
   codegen-units = 1      # Single codegen unit
   panic = "abort"        # Smaller panic handler
   strip = true           # Remove debug symbols
   ```

2. **wasm-opt Passes**:
   - `-Oz`: Aggressive size optimization
   - `--enable-simd`: SIMD support
   - `--vacuum`: Remove dead code
   - `--strip-debug`: Remove debug info

3. **Expected Bundle Sizes**:
   - Unoptimized WASM: ~2-4 MB
   - Optimized WASM: ~800 KB - 1.5 MB
   - Gzip compressed: ~250-500 KB
   - Brotli compressed: ~200-400 KB

### Network Optimization

**Enable compression on your server:**

**Nginx:**
```nginx
gzip on;
gzip_types application/wasm application/javascript text/css;
gzip_vary on;

brotli on;
brotli_types application/wasm application/javascript text/css;
```

**Apache (.htaccess):**
```apache
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE application/wasm
  AddOutputFilterByType DEFLATE application/javascript
</IfModule>
```

**Cloudflare Workers:**
```javascript
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  const response = await fetch(request)
  const newHeaders = new Headers(response.headers)
  newHeaders.set('Content-Encoding', 'br')
  return new Response(response.body, {
    status: response.status,
    headers: newHeaders
  })
}
```

### Caching Strategy

**HTTP Cache Headers (configured in deployment scripts):**

```
# Immutable assets (WASM, JS with hash)
Cache-Control: public, max-age=31536000, immutable

# HTML (always revalidate)
Cache-Control: public, max-age=0, must-revalidate

# Manifest
Cache-Control: public, max-age=86400
```

**Service Worker Cache:**
- Static assets: Cache-first strategy
- WASM files: Cache-first, network fallback
- Runtime: Network-first, cache fallback
- Audio files: Cache with 100MB size limit

---

## PWA Features

### Implemented Features

✅ **Offline Support**
- Service worker caches all static assets
- WASM binary cached for instant offline loading
- Audio files cached (up to 100MB)

✅ **Installable**
- Add to home screen on mobile
- Desktop PWA installation
- Custom install prompt

✅ **App-like Experience**
- Standalone display mode
- Custom theme color
- Splash screen with app icon

✅ **Performance**
- Fast loading with service worker
- Optimized WASM binary
- Progressive enhancement

### Manifest Configuration

Edit `www/manifest.json` to customize:

```json
{
  "name": "Rusty Audio Player",
  "short_name": "Rusty Audio",
  "theme_color": "#4ecdc4",
  "background_color": "#1a1a1a",
  "display": "standalone"
}
```

### Service Worker Customization

Edit `www/sw.js` for:
- Custom caching strategies
- Cache size limits
- Background sync
- Push notifications

---

## Troubleshooting

### Build Issues

**Error: `wasm32-unknown-unknown` target not found**
```bash
rustup target add wasm32-unknown-unknown
```

**Error: `wasm-bindgen` version mismatch**
```bash
cargo update -p wasm-bindgen
cargo install wasm-bindgen-cli --force
```

**Error: WASM binary too large**
- Ensure release profile is used
- Check wasm-opt is installed and running
- Review feature flags in Cargo.toml

### Runtime Issues

**WASM module fails to load**
- Check browser console for errors
- Verify MIME type: `Content-Type: application/wasm`
- Check CORS headers if loading from different domain

**Service Worker not registering**
- Must be served over HTTPS (or localhost)
- Check for errors in DevTools → Application → Service Workers
- Verify `sw.js` is in correct location

**PWA not installable**
- Requires HTTPS (localhost exempt)
- Must have valid manifest.json
- Need icons (192x192 and 512x512 minimum)
- Service worker must be registered

### Performance Issues

**Slow initial load**
- Enable gzip/brotli compression
- Use CDN for static assets
- Preload critical resources

**Memory issues**
- Check WASM memory usage in DevTools
- Limit audio file cache size in service worker
- Clear old caches periodically

---

## Bundle Size Analysis

### Measuring Bundle Size

```bash
# After build, analyze output
./scripts/build-wasm.sh
```

The script displays:
```
Bundle Analysis
----------------------------------------------
File                           Size
----------------------------------------------
index.html                     12.3 KB
manifest.json                  1.8 KB
sw.js                          8.5 KB
rusty_audio.js                 45.2 KB
rusty_audio_bg.wasm            1.2 MB
build-manifest.json            234 B
icons (8 files)                ~150 KB
----------------------------------------------
Total bundle size: 1.42 MB
```

### Optimization Tips

**Reduce WASM Size:**
1. Remove unused features in Cargo.toml
2. Use `opt-level = 'z'` instead of `opt-level = 3`
3. Run wasm-opt with `-Oz` flag
4. Strip unnecessary imports

**Reduce JavaScript Size:**
1. Minify JavaScript with terser
2. Use tree-shaking for imports
3. Remove debug logging in production

**Reduce Asset Size:**
1. Optimize PNG icons with pngquant
2. Use WebP format for screenshots
3. Remove unused fonts

### Expected Production Sizes

**Optimal production bundle (compressed):**
- WASM (brotli): ~200-400 KB
- JavaScript (brotli): ~10-20 KB
- HTML + CSS: ~5-10 KB
- Icons (all sizes): ~100-150 KB
- **Total first load**: ~300-600 KB

**Subsequent loads (cached):**
- Only HTML revalidation: ~5 KB

---

## Advanced Topics

### WASM Streaming Compilation

Enable faster startup with streaming compilation:

```javascript
// In index.html
async function loadWasm() {
  const { default: init, WebHandle } = await import('./rusty_audio.js');

  // Use streaming if supported
  if (WebAssembly.instantiateStreaming) {
    await init();
  } else {
    // Fallback for Safari
    await init();
  }

  // ... rest of initialization
}
```

### Multi-Threading with SharedArrayBuffer

Future enhancement for audio processing:

```toml
# Cargo.toml
[dependencies]
wasm-bindgen-rayon = "1.0"

[profile.release]
# Enable atomics and bulk memory
```

Requires CORS headers:
```
Cross-Origin-Embedder-Policy: require-corp
Cross-Origin-Opener-Policy: same-origin
```

### Analytics Integration

Add to `www/index.html`:

```javascript
// After WASM loads
window.rustyAudioHandle = handle;

// Track load time
performance.measure('wasm-load', 'wasm-load-start', 'wasm-load-end');
const loadTime = performance.getEntriesByName('wasm-load')[0].duration;

// Send to analytics
gtag('event', 'wasm_load', {
  'event_category': 'performance',
  'value': Math.round(loadTime)
});
```

---

## Resources

- [eframe WASM Documentation](https://github.com/emilk/egui/tree/master/crates/eframe#web)
- [wasm-bindgen Guide](https://rustwasm.github.io/wasm-bindgen/)
- [PWA Documentation](https://web.dev/progressive-web-apps/)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [WASM Optimization](https://rustwasm.github.io/book/reference/code-size.html)

---

## Support

For issues or questions:
1. Check [Troubleshooting](#troubleshooting) section
2. Review browser console errors
3. Verify all prerequisites are installed
4. Test in incognito mode (clean cache)

**Common Issues:**
- WASM MIME type: Configure server correctly
- HTTPS required: Use localhost for testing
- Service Worker: Check Application tab in DevTools
